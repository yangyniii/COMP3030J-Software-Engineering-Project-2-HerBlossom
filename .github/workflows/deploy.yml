name: Deploy to Remote Server

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.VM_NAME }} >> ~/.ssh/known_hosts

      - name: Deploy Application
        run: |
          ssh -tt -i ~/.ssh/id_rsa student@${{ secrets.VM_NAME }} << 'EOSSH'
            # 配置免密码 sudo (需提前在服务器配置)
            # echo 'student ALL=(ALL) NOPASSWD: ALL' | sudo tee /etc/sudoers.d/student

            # 更新系统
            sudo apt update && sudo apt upgrade -y

            # 配置 Git 凭据（如果使用 HTTPS）
            # git config --global credential.helper 'store --file ~/.git-credentials'
            # echo "https://${{ secrets.GH_USER }}:${{ secrets.GH_TOKEN }}@github.com" > ~/.git-credentials

            # 克隆或更新项目
            if [ ! -d "website" ]; then
              git clone https://${{ secrets.GH_USER }}:${{ secrets.GH_TOKEN }}@github.com/yangyniii/COMP3030J-Software-Engineering-Project-2.git website
            else
              cd website
              git pull origin main
              cd ..
            fi

            # 创建并激活虚拟环境
            cd website || exit 1
            python3 -m venv venv
            source venv/bin/activate

            # 安装依赖
            pip install -r requirements.txt

            # 安装和配置 Gunicorn
            pip install gunicorn
            cat << 'EOCONFIG' > gunicorn.conf.py
            import multiprocessing
            bind = '127.0.0.1:5000'
            workers = multiprocessing.cpu_count() * 2 + 1
            EOCONFIG

            # 创建 Gunicorn 服务
            sudo tee /etc/systemd/system/gunicorn.service > /dev/null << 'EOSERVICE'
            [Unit]
            Description=gunicorn daemon for Flask app
            Requires=gunicorn.socket
            After=network.target

            [Service]
            Type=notify
            User=student
            Group=student
            RuntimeDirectory=gunicorn
            WorkingDirectory=/home/student/website
            ExecStart=/home/student/website/venv/bin/gunicorn hello:app
            ExecReload=/bin/kill -s HUP \$MAINPID
            KillMode=mixed
            TimeoutStopSec=5
            PrivateTmp=true

            [Install]
            WantedBy=multi-user.target
            EOSERVICE

            sudo systemctl daemon-reload
            sudo systemctl enable --now gunicorn

            # 配置 Nginx
            sudo tee /etc/nginx/sites-available/${{ secrets.VM_NAME }} > /dev/null << 'EONGINX'
            upstream app_server {
                server unix:/run/gunicorn.sock;
            }

            server {
                listen 80;
                server_name ${{ secrets.VM_NAME }};

                location / {
                    proxy_pass http://app_server;
                    proxy_set_header Host \$host;
                    proxy_set_header X-Real-IP \$remote_addr;
                }
            }
            EONGINX

            sudo ln -sf /etc/nginx/sites-available/${{ secrets.VM_NAME }} /etc/nginx/sites-enabled/
            sudo nginx -t && sudo systemctl restart nginx
          EOSSH
