<!doctype html>
<html lang="en">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="shortcut icon" href="../static/img/favicon.ico" type="image/x-icon">
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="../static/assets/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="../static/assets/niceselectpicker/nice-select.css">
    <link rel="stylesheet" href="../static/assets/slick/slick.css">
    <link rel="stylesheet" href="../static/assets/slick/slick-theme.css">
    <!-- icon css_test-->
    <link rel="stylesheet" href="../static/assets/elagent-icon/style.css">
    <link rel="stylesheet" href="../static/assets/animation/animate.css">
    <link rel="stylesheet" href="../static/css_test/style.css">
    <link rel="stylesheet" href="../static/css_test/responsive.css">
    <title>HerBlossom - Forum Topics</title>
    <style>
        .like-button {
            cursor: pointer;
            color: #999;
            transition: color 0.3s ease;
            text-decoration: none;
        }

        .like-button.liked {
            color: #ff4444 !important;
        }

        .like-button:hover {
            color: #ff4444;
        }

        .like-button i {
            margin-right: 5px;
        }

        .likes-count {
            font-size: 14px;
        }
    </style>
</head>

<body data-scroll-animation="true">
        <div id="ai-float-button" onclick="toggleAIChat()">
        <img src="../static/img/favicon.ico" alt="AI Assistant" />
    </div>
    
    <div id="ai-chat-popup" class="hidden">
        <div class="ai-chat-header">
            <h4>AI Assistant</h4>
            <button class="close-btn" onclick="toggleAIChat()">×</button>
        </div>
        <div class="ai-chat-body">
            <div id="ai-chat-messages"></div>
            <textarea id="ai-chat-input" placeholder="Ask me anything..."></textarea>
            <button id="ai-chat-send" onclick="sendAIMessage()">Send</button>
        </div>
    </div>
    <div id="preloader">
        <div id="ctn-preloader" class="ctn-preloader">
            <div class="round_spinner">
                <div class="spinner"></div>
                <div class="text">
                    <img src="../static/img/spinner_logo.png" alt="">
                    <h4><span>HerBlossom</span></h4>
                </div>
            </div>
            <h2 class="head">Did You Know?</h2>
            <p></p>
        </div>
    </div>

    <div class="click_capture"></div>

    <div class="body_wrapper">
        <nav class="navbar navbar-expand-lg menu_one" id="sticky">
            <div class="container">
                <a class="navbar-brand sticky_logo" href="index.html">
                    <img src="../static/img/logo-w.png" srcset="../static/img/logo-w2x.png 2x" alt="logo">
                    <img src="../static/img/logo.png" srcset="../static/img/logo-2x.png 2x" alt="logo">
                </a>
                <button class="navbar-toggler collapsed" type="button" data-toggle="collapse"
                    data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"
                    aria-label="Toggle navigation">
                    <span class="menu_toggle">
                        <span class="hamburger">
                            <span></span>
                            <span></span>
                            <span></span>
                        </span>
                        <span class="hamburger-cross">
                            <span></span>
                            <span></span>
                        </span>
                    </span>
                </button>

                <div class="collapse navbar-collapse" id="navbarSupportedContent">
                    <ul class="navbar-nav menu ml-auto">
                        <li class="nav-item dropdown submenu">
                            <a href="/index" class="nav-link dropdown-toggle" role="button" data-toggle="dropdown"
                               aria-haspopup="true" aria-expanded="false">Home</a>
                            <i class="arrow_carrot-down_alt2 mobile_dropdown_icon" aria-hidden="true"
                               data-toggle="dropdown"></i>
                            <!--?                            <ul class="dropdown-menu">-->
                            <!--?                               <li class="nav-item"><a href="index.html" class="nav-link">Home</a></li>-->
                            <!--?                            </ul>-->
                        </li>
                        <li class="nav-item dropdown submenu mega_menu tab-demo">
                            <a href="/forum-topics" class="nav-link dropdown-toggle" role="button"
                               data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Forum</a>
                            <i class="arrow_carrot-down_alt2 mobile_dropdown_icon" aria-hidden="true"
                               data-toggle="dropdown"></i>
                        </li>
                        <li class="nav-item dropdown submenu mega_menu tab-demo">
                            <a href="/blog" class="nav-link dropdown-toggle" role="button" data-toggle="dropdown"
                               aria-haspopup="true" aria-expanded="false">Blog</a>
                        </li>
                        <li class="nav-item dropdown submenu mega_menu tab-demo">
                            <a href="/job-recommendation" class="nav-link dropdown-toggle" role="button" data-toggle="dropdown"
                               aria-haspopup="true" aria-expanded="false">Job Recommendation</a>
                        </li>
                        <li class="nav-item dropdown submenu">
                            <a class="nav-link dropdown-toggle" href="#" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Products</a>
                            <i class="arrow_carrot-down_alt2 mobile_dropdown_icon" aria-hidden="false" data-toggle="dropdown"></i>
                            <ul class="dropdown-menu dropdown_menu_two">
                                <li class="nav-item">
                                    <a href="/contact-us" class="nav-link">
                                        <img src="../static/img/tick.png" alt="">
                                        <div class="text">
                                            <h5>Contact Us</h5>
                                            <p>Send your feedback here!</p>
                                        </div>
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a href="/about-us" class="nav-link">
                                        <img src="../static/img/sheet.png" alt="">
                                        <div class="text">
                                            <h5>About Us</h5>
                                            <p>Want to know more about<br>QUEENs NEVER CRY?</p>
                                        </div>
                                    </a>
                                </li>
                            </ul>
                        </li>
                    </ul>
                    <a class="nav_btn" href="/signin" id="auth-button">Sign In</a>
                </div>
            </div>
        </nav>

        <section class="breadcrumb_area">
            <img class="p_absolute bl_left" src="../static/img/v.svg" alt="">
            <img class="p_absolute bl_right" src="../static/img/home_one/b_leaf.svg" alt="">
            <img class="p_absolute star" src="../static/img/home_one/banner_bg.png" alt="">
            <img class="p_absolute wave_shap_one" src="../static/img/blog-classic/shap_01.png" alt="">
            <img class="p_absolute wave_shap_two" src="../static/img/blog-classic/shap_02.png" alt="">
            <img class="p_absolute one wow fadeInRight" src="../static/img/home_one/b_man_two.png" alt="">
            <img class="p_absolute two wow fadeInUp" data-wow-delay="0.2s" src="../static/img/home_one/flower.png" alt="">
            <div class="container custom_container">
                <form action="#" class="banner_search_form banner_search_form_two">
                    <div class="input-group">
                        <label for="search-input"></label><input id="search-input" type="search" class="form-control" placeholder='Search ("/" to focus)'>

                        <button id="search-button" type="submit"><i class="icon_search"></i></button>
                    </div>
                </form>
            </div>
        </section>

        <section class="page_breadcrumb">
            <div class="container">
                <div class="row">
                    <div class="col-sm-7">
                        <nav aria-label="breadcrumb">
                            <ol class="breadcrumb">
                                <li class="breadcrumb-item"><a href="/index">Home</a></li>
                                <li class="breadcrumb-item">Forum</li>
                                </ol>
                        </nav>
                    </div>
                    <div class="col-sm-5">
                        <span class="date"><i class="icon_clock_alt"></i>Updated on March 03, 2020</span>
                    </div>
                </div>
            </div>
        </section>
        <section class="doc_blog_grid_area sec_pad forum-page-content">
            <div class="container">
                <div class="row">
                    <div class="col-lg-8">
                        <div class="communities-boxes">
                            <div class="HerBlossom-com-box">
                                <div class="icon-container">
                                    <img src="../static/img/home_support/rc1.png" alt="communinity-box">
                                </div>

                                <div class="HerBlossom-com-box-content">
                                    <h3 class="title"><a href="#" onclick="scrollToPosts()">Getting Started</a></h3>
                                    <p class="total-post">Join the forum!</p>
                                </div>
                                <!-- /.HerBlossom-com-box-content -->
                            </div>
                            <!-- /.HerBlossom-com-box -->

                            <div class="HerBlossom-com-box">
                                <div class="icon-container">
                                    <img src="../static/img/home_support/rc2.png" alt="communinity-box">
                                </div>

                                <div class="HerBlossom-com-box-content">
                                    <h3 class="title"><a href="#" onclick="scrollToRanking()">Ranking List</a></h3>
                                    <p class="total-post">Give a like!</p>
                                </div>
                                <!-- /.HerBlossom-com-box-content -->
                            </div>
                            <!-- /.HerBlossom-com-box -->

                            <div class="HerBlossom-com-box">
                                <div class="icon-container">
                                    <img src="../static/img/home_support/rc3.png" alt="communinity-box">
                                </div>

                                <div class="HerBlossom-com-box-content">
                                    <h3 class="title"><a href="#" onclick="scrollToTags()">Tags</a></h3>
                                    <p class="total-post">Filter tags!</p>
                                </div>
                                <!-- /.HerBlossom-com-box-content -->
                            </div>
                            <!-- /.HerBlossom-com-box -->

                            <div class="HerBlossom-com-box">
                                <div class="icon-container">
                                    <img src="../static/img/home_support/rc4.png" alt="communinity-box">
                                </div>

                                <div class="HerBlossom-com-box-content">
                                    <h3 class="title"><a href="/blog-list">Blogs</a></h3>
                                    <p class="total-post">View blogs!</p>
                                </div>
                                <!-- /.HerBlossom-com-box-content -->
                            </div>
                            <!-- /.HerBlossom-com-box -->

                        </div>
                        <!-- /.communities-boxes -->

                        <div class="answer-action">
                            <div class="action-content">
                                <div class="image-wrap">
                                    <img src="../static/img/home_support/answer.png" alt="answer action">
                                </div>

                                <div class="content">
                                    <h2 class="ans-title">Can't find an answer?</h2>
                                    <p>
                                        Make use of a qualified tutor to get the answer
                                    </p>
                                </div>
                            </div>
                            <!-- /.action-content -->

                            <div class="action-button-container">
                                <a href="/post-edit" class="action_btn btn-ans">Ask a Question</a>
                            </div>
                            <!-- /.action-button-container -->
                        </div>
                        <!-- /.answer-action -->


                        <!-- /.post-header -->

                        <div class="community-posts-wrapper bb-radius" id="post-list">
                            <div class="community-post style-two HerBlossom richard bug">

                            </div>
                            <!-- /.community-post -->
                        </div>
                        <!-- /.community-posts-wrapper -->

                        <div class="pagination-wrapper">
                            <div class="view-post-of" id="pagination-info">
                                <!-- 这里的内容会通过 JavaScript 动态更新 -->
                            </div>
                            <ul class="post-pagination">
                                <!-- 翻页按钮会通过 JavaScript 动态生成 -->
                            </ul>
                        </div>
                        <!-- /.pagination-wrapper -->

                    </div>
                    <!-- /.col-lg-8 -->

                    <div class="col-lg-4">
                        <div class="forum_sidebar">
                            <div class="widget status_widget">
                                <h4 class="c_head">Information</h4>
                                <p class="status">Support is <span class="offline">Offline</span></p>

                                <div class="open-hours">
                                    <h4 class="title-sm">Our office hours</h4>
                                    <p>Monday - Friday / 10am - 6pm (UTC +4) Beijing</p>
                                    <ul class="current-time list-unstyled">
                                        <li>
                                            <h4 class="title-sm">Beijing Time</h4>
                                            <p id="beijing-time">Loading...</p>
                                            <p id="beijing-date">Loading...</p>
                                            <p id="beijing-day">Loading...</p>
                                        </li>
                                        <li>
                                            <h4 class="title-sm">Dublin Time</h4>
                                            <p id="dublin-time">Loading...</p>
                                            <p id="dublin-date">Loading...</p>
                                            <p id="dublin-day">Loading...</p>
                                        </li>
                                    </ul>
                                </div>
                                <!-- /.open-hours -->

                            </div>


                            <div class="widget ticket_widget">
                                <h4 class="c_head">Ranking List</h4>
                                <ul class="list-unstyled ticket_categories" id="ranking-list">
                                    <!-- 排行榜内容将通过 JavaScript 动态加载 -->
                                </ul>
                            </div>

                            <div class="widget tag_widget">
                                <h4 class="c_head">Tags</h4>
                                <ul class="list-unstyled w_tag_list style-light" id="tag-cloud">
                                    <li><a href="#" onclick="return false;">Loading tags...</a></li>
                                </ul>
                            </div>

                        </div>
                    </div>
                    <!-- /.col-lg-4 -->
                </div>
            </div>
        </section>

        <div class="call-to-action">
            <div class="overlay-bg"></div>
            <div class="container">
                <div class="action-content-wrapper">
                    <div class="action-title-wrap title-img">
                        <img src="../static/img/home_support/chat-smile.png" alt="">
                        <h2 class="action-title">New to Communities?</h2>
                    </div>
                    <a href="/forum-topics" class="action_btn">Join the community <i class="arrow_right"></i></a>
                </div>
                <!-- /.action-content-wrapper -->
            </div>
            <!-- /.container -->
        </div>
        <!-- /.call-to-action -->
        <footer class="footer_area footer_p_top f_bg_color">
            <img class="p_absolute leaf" src="../static/img/v.svg" alt="">
            <img class="p_absolute f_man wow fadeInLeft" data-wow-delay="0.4s" src="../static/img/home_two/f_man.png"
                 alt="">
            <img class="p_absolute f_cloud" src="../static/img/home_two/cloud.png" alt="">
            <img class="p_absolute f_email" src="../static/img/home_two/email-icon.png" alt="">
            <img class="p_absolute f_email_two" src="../static/img/home_two/email-icon_two.png" alt="">
            <img class="p_absolute f_man_two wow fadeInLeft" data-wow-delay="0.2s" src="../static/img/home_two/man.png"
                 alt="">
            <div class="footer_top">
                <div class="container">
                    <div class="row">
                        <div class="col-lg-4 col-sm-6">
                            <div class="f_widget subscribe_widget wow fadeInUp">
                                <a href="index.html" class="f_logo"><img src="../static/img/logo.png" alt=""></a>
                                <h4 class="c_head">Subscribe to our newsletter</h4>
                                <form action="#" class="footer_subscribe_form">
                                    <input type="email" placeholder="Email" class="form-control">
                                    <button type="submit" class="s_btn">Send</button>
                                </form>
                                <ul class="list-unstyled f_social_icon">
                                    <li><a href="#"><i class="social_facebook"></i></a></li>
                                    <li><a href="#"><i class="social_twitter"></i></a></li>
                                    <li><a href="#"><i class="social_vimeo"></i></a></li>
                                    <li><a href="#"><i class="social_linkedin"></i></a></li>
                                </ul>
                            </div>
                        </div>


                        <div class="col-lg-3 col-sm-6">
                            <div class="f_widget link_widget pl_70 wow fadeInUp" data-wow-delay="0.6s">
                                <h3 class="f_title">HerBlossom Pages</h3>
                                <ul class="list-unstyled link_list">
                                    <li><a href="/index">Home</a></li>
                                    <li><a href="/signin">Sign In</a></li>
                                    <li><a href="/blog">Blog</a></li>
                                    <li><a href="/forum">Forum</a></li>
                                    <li><a href="/job-recommendation">Job Recommendation</a></li>

                                    <!--                                <li><a href="changelog.html">Changelog</a></li>-->
                                    <!--                                <li><a href="Onepage.html">Onepage Docs</a></li>-->
                                    <!--                                <li><a href="#">Conversion Tracking</a></li>-->
                                    <!--                                <li><a href="cheatsheet.html">Cheatseet</a></li>-->
                                </ul>
                            </div>
                        </div>

                        <div class="col-lg-2 col-sm-6">
                            <div class="f_widget link_widget wow fadeInUp" data-wow-delay="0.4s">
                                <h3 class="f_title">Blog</h3>
                                <ul class="list-unstyled link_list">
                                    <li><a href="/blog">Blog</a></li>
                                    <li><a href="/blog-category/Skills">Life Skills</a></li>
                                    <li><a href="/blog-category/Health">Physical & Mental Health</a></li>
                                    <li><a href="/blog-category/Others">Others</a></li>
                                    <!--                                <li><a href="#">Image Lightbox</a></li>-->
                                    <!--                                <li><a href="#">iOS & Android</a></li>-->
                                    <!--                                <li><a href="#">Messages</a></li>-->
                                </ul>
                            </div>
                        </div>

                        <div class="col-lg-3 col-sm-6">
                            <div class="f_widget link_widget pl_30 wow fadeInUp" data-wow-delay="0.2s">
                                <h3 class="f_title">Company</h3>
                                <ul class="list-unstyled link_list">
                                    <li><a href="/about-us">About Us</a></li>
                                    <li><a href="/contact-us">Contact Us</a></li>

                                    <!--                                <li><a href="#">Careers</a></li>-->
                                    <!--                                <li><a href="#">HerBlossom for Good</a></li>-->
                                    <!--                                <li><a href="#">Contact Us</a></li>-->
                                </ul>
                            </div>
                        </div>

                    </div>
                    <div class="border_bottom"></div>
                </div>
            </div>
            <div class="footer_bottom text-center">
                <div class="container">
                    <p>© 2025 All Rights Reserved by <a href="/index">HerBlossom</a></p>
                </div>
            </div>
        </footer>
    </div>

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js_test, then Bootstrap JS -->
    <script src="../static/js_test/jquery-3.2.1.min.js"></script>
    <script src="../static/js_test/pre-loader.js"> </script>
    <script src="../static/assets/bootstrap/js/popper.min.js"></script>
    <script src="../static/assets/bootstrap/js/bootstrap.min.js"></script>
    <script src="../static/assets/niceselectpicker/jquery.nice-select.min.js"></script>
    <script src="../static/assets/slick/slick.min.js"></script>
    <script src="../static/js_test/parallaxie.js"></script>
    <script src="../static/js_test/TweenMax.min.js"></script>
    <script src="../static/js_test/jquery.wavify.js"></script>
    <script src="../static/assets/wow/wow.min.js"></script>
    <script src="../static/js_test/main.js"></script>
    <script src="../static/js/change-button.js"></script>
</body>
<script>
    const postsPerPage = 3;
    let allPosts = [];
    let currentPage = 1;

    const userAvatarMap = new Map();
    const userNameMap = new Map();

    window.onload = function () {
        console.log("Page fully loaded");

        fetch('/post_posts')
            .then(response => response.json())
            .then(data => {
                allPosts = data.posts || [];
                renderPagination();
                renderPostsForPage(currentPage);
                // 加載標籤
                loadTags();
            })
            .catch(error => console.error('Error fetching posts:', error));
    }
    
    // 加載標籤雲
    function loadTags() {
        fetch('/get_all_tags')
            .then(response => response.json())
            .then(data => {
                const tagCloud = document.getElementById('tag-cloud');
                tagCloud.innerHTML = '';
                
                if (data.tags && data.tags.length > 0) {
                    data.tags.forEach(tag => {
                        const tagItem = document.createElement('li');
                        tagItem.innerHTML = `<a href="#" onclick="searchByTag('${tag}'); return false;">${tag}</a>`;
                        tagCloud.appendChild(tagItem);
                    });
                } else {
                    tagCloud.innerHTML = '<li><a href="#" onclick="return false;">No tags found</a></li>';
                }
            })
            .catch(error => {
                console.error('Error fetching tags:', error);
                const tagCloud = document.getElementById('tag-cloud');
                tagCloud.innerHTML = '<li><a href="#" onclick="return false;">Error loading tags</a></li>';
            });
    }
    
    // 通過標籤搜索帖子
    function searchByTag(tag) {
        fetch(`/search_by_tag?tag=${encodeURIComponent(tag)}`)
            .then(response => response.json())
            .then(data => {
                const postList = document.getElementById('post-list');
                postList.innerHTML = ''; // 清空現有帖子
                
                if (data.posts && data.posts.length > 0) {
                    // 更新全局帖子數組
                    allPosts = data.posts;
                    // 重新渲染分頁和帖子
                    currentPage = 1;
                    renderPagination();
                    renderPostsForPage(currentPage);
                    
                    // 滾動到帖子列表
                    scrollToPosts();
                } else {
                    postList.innerHTML = '<p>找不到標籤為 "' + tag + '" 的帖子</p>';
                }
            })
            .catch(error => console.error('Error searching by tag:', error));
    }

    function renderPostsForPage(page) {
        const postList = document.getElementById('post-list');
        postList.innerHTML = '';

        const start = (page - 1) * postsPerPage;
        const end = start + postsPerPage;
        const postsToShow = allPosts.slice(start, end);

postsToShow.forEach(post => {
    const postItem = document.createElement('div');
    postItem.className = 'community-post style-two';
    postItem.innerHTML = `
        <div class="post-content">
            <div class="author-avatar">
                    <img src="${userAvatarMap.get(post.user_id) || '../static/images/chiikawa.jpg'}" alt="avatar" style="width: 80%; height: auto;">
                </div>
            <div class="entry-content">
                <h3 class="post-title">
                    <a href="/forum-single?post_id=${post.post_id}">${post.title}</a>
                </h3>
                <div class="post-preview">
                    ${post.content.length > 10 ? post.content.substring(0, 100) + '...' : post.content}
                </div>
                <ul class="meta">
                    <li>
                        <img src="../static/img/home_support/cmm1.png" alt="cmm" style="width: 30%; height: 30%;">
                        <a href="#" data-userid="${post.user_id}">${userNameMap.get(post.user_id) || 'Loading...'}</a>
                    </li>
                    <span style="margin-left: 360px;"></span>
                    <li><i class="icon_calendar"></i>${post.create_time}</li>
                </ul>

                <div class="post-meta-wrapper">
                    <ul class="post-meta-info">
                        <span style="margin-left: 450px;"></span>

                        <li>
                            <a href="#" class="like-button" data-post-id="${post.post_id}" onclick="toggleLike(event, ${post.post_id})">
                                <i class="icon_heart"></i>
                                <span class="likes-count">0</span>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    `;
    postList.appendChild(postItem);

    const userLink = postItem.querySelector('a[data-userid]');
    fetchUserAndSetUsername(post.user_id, userLink);

    // 获取点赞信息
    fetchPostLikes(post.post_id);
});
    }

    function renderPagination() {
        const totalPages = Math.ceil(allPosts.length / postsPerPage);
        const paginationList = document.querySelector('.post-pagination');
        const paginationInfo = document.getElementById('pagination-info');
        paginationList.innerHTML = '';

        // 动态更新分页信息文字
        const start = (currentPage - 1) * postsPerPage + 1;
        const end = Math.min(currentPage * postsPerPage, allPosts.length);
        paginationInfo.innerHTML = `<p>Viewing ${allPosts.length} topics - ${start} through ${end} (of ${allPosts.length} total)</p>`;

        // Prev Button
        const prev = document.createElement('li');
        prev.className = currentPage === 1 ? 'prev-post pegi-disable' : 'prev-post';
        prev.innerHTML = `<a href="#"><i class="arrow_carrot-left"></i></a>`;
        prev.onclick = () => {
            if (currentPage > 1) {
                currentPage--;
                renderPostsForPage(currentPage);
                renderPagination();
            }
        };
        paginationList.appendChild(prev);

        // Page numbers
        for (let i = 1; i <= totalPages; i++) {
            const pageLi = document.createElement('li');
            pageLi.innerHTML = `<a href="#" class="${i === currentPage ? 'active' : ''}">${i}</a>`;
            pageLi.onclick = () => {
                currentPage = i;
                renderPostsForPage(currentPage);
                renderPagination();
            };
            paginationList.appendChild(pageLi);
        }

        // Next Button
        const next = document.createElement('li');
        next.className = currentPage === totalPages ? 'next-post pegi-disable' : 'next-post';
        next.innerHTML = `<a href="#"><i class="arrow_carrot-right"></i></a>`;
        next.onclick = () => {
            if (currentPage < totalPages) {
                currentPage++;
                renderPostsForPage(currentPage);
                renderPagination();
            }
        };
        paginationList.appendChild(next);
    }

    function fetchUserAndSetUsername(userId, element) {
        if (userNameMap.has(userId)) {
            element.textContent = userNameMap.get(userId);
            return;
        }

        fetch(`/get_user_info_by_id?user_id=${userId}`)
            .then(response => response.json())
            .then(data => {
                const username = data.username || 'Unknown User';
                const avatar = data.avatar || '../static/images/chiikawa.jpg';

                userNameMap.set(userId, username);
                userAvatarMap.set(userId, avatar);

                element.textContent = username;
                const avatarImg = element.closest('.author-avatar').querySelector('img');
                if (avatarImg) {
                    avatarImg.src = avatar;
                }
            })
            .catch(error => console.error('Error fetching user info:', error));
    }

    // Function to fetch posts
    function fetchPosts(searchTerm) {
        fetch(`/search_posts?title=${encodeURIComponent(searchTerm)}`)
            .then(response => response.json())
            .then(data => {
                const postList = document.getElementById('post-list');
                postList.innerHTML = ''; // Clear existing posts
                
                if (data.posts && data.posts.length > 0) {
                    // 更新全局帖子數組
                    allPosts = data.posts;
                    // 重新渲染分頁和帖子
                    currentPage = 1;
                    renderPagination();
                    renderPostsForPage(currentPage);
                } else {
                    postList.innerHTML = '<p>No relevant posts were found.</p>';
                }
            })
            .catch(error => console.error('Error:', error));
    }

    // 添加滚动功能
    function scrollToPosts() {
        const postList = document.getElementById('post-list');
        postList.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    function scrollToRanking() {
        const ticketCategories = document.querySelector('.ticket_widget');
        ticketCategories.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    function scrollToTags() {
        const tagsWidget = document.querySelector('.tag_widget');
        tagsWidget.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
    // 搜索按钮点击事件
    document.getElementById('search-button').addEventListener('click', function (e) {
            e.preventDefault(); // 阻止默认行为
            const searchTerm = document.getElementById('search-input').value;
            fetchPosts(searchTerm);
        });

        // 输入框回车事件
        document.getElementById('search-input').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                e.preventDefault(); // 阻止默认行为
                const searchTerm = document.getElementById('search-input').value;
                fetchPosts(searchTerm);
            }
        });
        function toggleAIChat() {
            const popup = document.getElementById('ai-chat-popup');
            popup.style.display = (popup.style.display === 'none' || popup.style.display === '') ? 'flex' : 'none';
        }

        async function sendAIMessage() {
            const input = document.getElementById('ai-chat-input');
            const message = input.value.trim();
            if (!message) return;

            const messagesDiv = document.getElementById('ai-chat-messages');
            messagesDiv.innerHTML += `<div><strong>You:</strong> ${message}</div>`;
            input.value = '';

            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ message })
            });

            const data = await response.json();
            messagesDiv.innerHTML += `<div><strong>AI:</strong> ${data.reply}</div>`;
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

    async function fetchPostLikes(postId) {
        fetch(`/get_post_likes?post_id=${postId}`)
            .then(response => response.json())
            .then(data => {
                const likeButton = document.querySelector(`.like-button[data-post-id="${postId}"]`);
                if (likeButton) {
                    const likesCount = likeButton.querySelector('.likes-count');
                    likesCount.textContent = data.likes_count;
                    
                    // 更新點讚按鈕狀態
                    if (data.has_liked) {
                        likeButton.classList.add('liked');
                        likeButton.querySelector('i').classList.add('liked');
                    } else {
                        likeButton.classList.remove('liked');
                        likeButton.querySelector('i').classList.remove('liked');
                    }
                }
            })
            .catch(error => console.error('Error fetching post likes:', error));
    }

    async function toggleLike(event, postId) {
        event.preventDefault();
        
        try {
            const response = await fetch('/toggle_like', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ post_id: postId })
            });
            
            const data = await response.json();
            
            if (data.success) {
                // 刷新頁面
                window.location.reload();
                const likeButton = document.querySelector(`.like-button[data-post-id="${postId}"]`);
                
                if (likeButton) {
                    const likesCount = likeButton.querySelector('.likes-count');
                    likesCount.textContent = data.likes_count;
                    
                    if (data.has_liked) {
                        likeButton.classList.add('liked');
                        likeButton.querySelector('i').classList.add('liked');
                    } else {
                        likeButton.classList.remove('liked');
                        likeButton.querySelector('i').classList.remove('liked');
                    }
                }
            } else {
                alert(data.message || 'Error');
            }
        } catch (error) {
            console.error('Error toggling like:', error);
            alert('Operation failed. Please try again later.');
        }
    }
// 获取点赞排行的帖子
    fetch('/get_top_posts')
        .then(response => response.json())
        .then(data => {
            const rankingList = document.getElementById('ranking-list');
            rankingList.innerHTML = ''; // 清空现有内容

            if (data.success && data.top_posts.length > 0) {
                data.top_posts.forEach(post => {
                    const listItem = document.createElement('li');
                    listItem.innerHTML = `
                        <a href="/forum-single?post_id=${post.post_id}">
                            ${post.title} <span class="count">${post.likes_count} Likes</span>
                        </a>
                    `;
                    rankingList.appendChild(listItem);
                });
            } else {
                rankingList.innerHTML = '<li>No posts available</li>';
            }
        })
        .catch(error => {
            console.error('Error fetching ranking list:', error);
            const rankingList = document.getElementById('ranking-list');
            rankingList.innerHTML = '<li>Error loading ranking list</li>';
        });

    function updateTime() {
        const beijingTimeElement = document.getElementById('beijing-time');
        const beijingDateElement = document.getElementById('beijing-date');
        const beijingDayElement = document.getElementById('beijing-day');
        const dublinTimeElement = document.getElementById('dublin-time');
        const dublinDateElement = document.getElementById('dublin-date');
        const dublinDayElement = document.getElementById('dublin-day');

        const now = new Date();

        // 获取星期几的名称
        const daysOfWeek = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];

        // 北京时间 (UTC+8)
        const beijingTime = new Date(now.toLocaleString("en-US", { timeZone: "Asia/Shanghai" }));
        beijingTimeElement.textContent = beijingTime.toLocaleTimeString();
        beijingDateElement.textContent = beijingTime.toLocaleDateString();
        beijingDayElement.textContent = daysOfWeek[beijingTime.getDay()];

        // 都柏林时间 (UTC 或 UTC+1)
        const dublinTime = new Date(now.toLocaleString("en-US", { timeZone: "Europe/Dublin" }));
        dublinTimeElement.textContent = dublinTime.toLocaleTimeString();
        dublinDateElement.textContent = dublinTime.toLocaleDateString();
        dublinDayElement.textContent = daysOfWeek[dublinTime.getDay()];
    }

    // 每秒更新一次时间
    setInterval(updateTime, 1000);
    updateTime();

</script>

</html>
</html>